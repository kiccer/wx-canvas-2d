!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.WxCanvas2d=e():t.WxCanvas2d=e()}(window,(function(){return function(t){var e={};function i(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(o,r,function(e){return t[e]}.bind(null,r));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}i.r(e);var r=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],s=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function n(t,e,i,r,s){if("string"==typeof t&&(t=document.getElementById(t)),!t||"object"!==o(t)||!("getContext"in t))throw new TypeError("Expecting canvas with `getContext` method in processCanvasRGB(A) calls!");var n=t.getContext("2d");try{return n.getImageData(e,i,r,s)}catch(t){throw new Error("unable to access image data: "+t)}}function h(t,e,i,o,h,l){if(!(isNaN(l)||l<1)){l|=0;var a=n(t,e,i,o,h);a=function(t,e,i,o,n,h){for(var l,a=t.data,d=2*h+1,u=o-1,x=n-1,g=h+1,p=g*(g+1)/2,f=new c,w=f,y=1;y<d;y++)w=w.next=new c,y===g&&(l=w);w.next=f;for(var b,m,v=null,D=null,S=r[h],C=s[h],P=0,W=0,T=0;T<n;T++){var I=a[W],L=a[W+1],F=a[W+2],$=g*I,j=g*L,B=g*F,O=p*I,E=p*L,M=p*F;w=f;for(var z=0;z<g;z++)w.r=I,w.g=L,w.b=F,w=w.next;for(var R=0,q=0,A=0,k=1;k<g;k++)b=W+((u<k?u:k)<<2),O+=(w.r=I=a[b])*(m=g-k),E+=(w.g=L=a[b+1])*m,M+=(w.b=F=a[b+2])*m,R+=I,q+=L,A+=F,w=w.next;v=f,D=l;for(var H=0;H<o;H++)a[W]=O*S>>C,a[W+1]=E*S>>C,a[W+2]=M*S>>C,O-=$,E-=j,M-=B,$-=v.r,j-=v.g,B-=v.b,b=P+((b=H+h+1)<u?b:u)<<2,R+=v.r=a[b],q+=v.g=a[b+1],A+=v.b=a[b+2],O+=R,E+=q,M+=A,v=v.next,$+=I=D.r,j+=L=D.g,B+=F=D.b,R-=I,q-=L,A-=F,D=D.next,W+=4;P+=o}for(var _=0;_<o;_++){var Q=a[W=_<<2],J=a[W+1],N=a[W+2],G=g*Q,K=g*J,U=g*N,V=p*Q,X=p*J,Y=p*N;w=f;for(var Z=0;Z<g;Z++)w.r=Q,w.g=J,w.b=N,w=w.next;for(var tt=0,et=0,it=0,ot=1,rt=o;ot<=h;ot++)W=rt+_<<2,V+=(w.r=Q=a[W])*(m=g-ot),X+=(w.g=J=a[W+1])*m,Y+=(w.b=N=a[W+2])*m,tt+=Q,et+=J,it+=N,w=w.next,ot<x&&(rt+=o);W=_,v=f,D=l;for(var st=0;st<n;st++)a[b=W<<2]=V*S>>C,a[b+1]=X*S>>C,a[b+2]=Y*S>>C,V-=G,X-=K,Y-=U,G-=v.r,K-=v.g,U-=v.b,b=_+((b=st+g)<x?b:x)*o<<2,V+=tt+=v.r=a[b],X+=et+=v.g=a[b+1],Y+=it+=v.b=a[b+2],v=v.next,G+=Q=D.r,K+=J=D.g,U+=N=D.b,tt-=Q,et-=J,it-=N,D=D.next,W+=o}return t}(a,0,0,o,h,l),t.getContext("2d").putImageData(a,e,i)}}var c=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.r=0,this.g=0,this.b=0,this.a=0,this.next=null};const l=wx.getSystemInfoSync();class a{constructor(){this.query=null,this.bgColor=null,this.radius=null,this.component=null,this.canvas=null,this.ctx=null,this.dpr=null,this.rootWidth=null,this.fontFamily="sans-serif",this.startTime=Date.now(),this.debugger=!1}create(t){return new Promise((e,i)=>{const o={query:"",rootWidth:375,...t};o.query||i(new Error("[WxCanvas2d] 'query' is empty.")),this.query=o.query,this.bgColor=o.bgColor,this.component=o.component,this.radius=o.radius;(this.component?wx.createSelectorQuery().in(this.component):wx.createSelectorQuery()).select(this.query).fields({node:!0,size:!0}).exec(t=>{if(!t[0])return!1;const i=t[0].node,r=i.getContext("2d"),s=l.pixelRatio;this.canvas=i,this.ctx=r,this.dpr=s,this.rootWidth=o.rootWidth,this.canvas.width=t[0].width*this.dpr,this.canvas.height=t[0].height*this.dpr,e()})})}clear(){this.ctx.clearRect(0,0,this.xDpr(this.canvas.width),this.xDpr(this.canvas.height)),this.radius&&(this.drawRectPath({x:0,y:0,width:this.canvas.width/l.screenWidth/this.dpr*this.rootWidth,height:this.canvas.height/l.screenWidth/this.dpr*this.rootWidth,radius:this.radius}),this.ctx.clip()),this.bgColor&&(this.ctx.fillStyle=this.bgColor,this.ctx.fillRect(0,0,this.xDpr(this.canvas.width),this.xDpr(this.canvas.height)))}xDpr(t){return t*this.dpr*l.screenWidth/this.rootWidth}draw(t){return new Promise((e,i)=>{this.startTime=Date.now();const{series:o}=t;(this.component?wx.createSelectorQuery().in(this.component):wx.createSelectorQuery()).select(this.query).fields({node:!0,size:!0}).exec(t=>{if(!t[0])return!1;this.canvas.width=t[0].width*this.dpr,this.canvas.height=t[0].height*this.dpr,this.clear();const r=o.map(t=>({...t,zIndex:t.zIndex||0})).sort((t,e)=>t.zIndex-e.zIndex),s={rect:(t,...e)=>this.drawRect(...e),image:(t,...e)=>this.drawImage(...e),text:(t,...e)=>this.drawText(...e),line:(t,...e)=>this.drawLine(...e),blur:(t,...e)=>this.drawBlur(...e),...a.extendDrawMethods},n=(t=0)=>{if(t<r.length){const e=r[t];s[e.type]?(this.styleClear(),s[e.type](this,e).then(()=>{this.debugLogout(`绘制成功 [${e.type}] (${t+1}/${r.length})`),n(++t)}).catch(t=>{this.debugLogout("绘制失败"),i(t)})):(this.debugLogout(`未知类型 type: '${e.type}'`,"error"),n(++t))}else this.debugLogout(`绘制完成 (${Date.now()-this.startTime}ms)`),e()};this.debugLogout("开始绘制"),n()})})}styleClear(){this.ctx.setTextAlign="left",this.ctx.textBaseline="top",this.ctx.fillStyle="#000",this.ctx.font=`${this.xDpr(12*this.rootWidth/l.screenWidth)}px ${this.fontFamily}`,this.ctx.lineCap="butt",this.ctx.setLineDash([1,0]),this.ctx.lineDashOffset=0,this.ctx.lineJoin="bevel",this.ctx.lineWidth=this.xDpr(1),this.ctx.strokeStyle="#000"}drawRect(t){return new Promise((e,i)=>{const o={x:0,y:0,width:0,height:0,color:"",bgColor:"",radius:0,...t};this.ctx.strokeStyle=o.color,this.ctx.fillStyle=o.bgColor,this.drawRectPath({x:o.x,y:o.y,width:o.width,height:o.height,radius:o.radius}),o.color&&this.ctx.stroke(),o.bgColor&&this.ctx.fill(),e()})}drawRectPath(t){const e={x:0,y:0,width:0,height:0,radius:0,...t},{x:i,y:o,width:r,height:s,radius:n}=e,h={top:1.5*Math.PI,right:0,bottom:.5*Math.PI,left:Math.PI},c=[[h.left,h.top],[h.top,h.right],[h.right,h.bottom],[h.bottom,h.left]],l=[[i+n,o+n].map(t=>this.xDpr(t)),[i+r-n,o+n].map(t=>this.xDpr(t)),[i+r-n,o+s-n].map(t=>this.xDpr(t)),[i+n,o+s-n].map(t=>this.xDpr(t))];this.ctx.beginPath(),Array(4).fill().forEach((t,e)=>{this.ctx.arc(...l[e],this.xDpr(n),...c[e])}),this.ctx.closePath()}drawImage(t){const e={url:"",x:0,y:0,width:0,height:0,mode:"scaleToFill",radius:0,...t};return new Promise((t,i)=>{const{url:o,x:r,y:s,width:n,height:h,mode:c,radius:l}=e,a=this.canvas.createImage();a.src=o,a.onload=()=>{wx.getImageInfo({src:o,success:e=>{const i=e.width,o=e.height,d=n/h;let u=1,x=1;"aspectFit"===c?(u=e.width/e.height<d?n/e.width*e.height/h:1,x=e.width/e.height>d?h/e.height*e.width/n:1):"aspectFill"===c&&(u=e.width/e.height>d?n/e.width*e.height/h:1,x=e.width/e.height<d?h/e.height*e.width/n:1);const g={scaleToFill:[0,0,i,o],aspectFit:[(e.width-e.width*u)/2,(e.height-e.height*x)/2,e.width*u,e.height*x],aspectFill:[(e.width-e.width*u)/2,(e.height-e.height*x)/2,e.width*u,e.height*x],widthFix:[],top:[(i-n)/2,0,n,h],bottom:[(i-n)/2,o-h,n,h],center:[(i-n)/2,(o-h)/2,n,h],left:[0,(o-h)/2,n,h],right:[i-n,(o-h)/2,n,h],"top left":[0,0,n,h],"top right":[i-n,0,n,h],"bottom left":[0,o-h,n,h],"bottom right":[i-n,o-h,n,h]};l&&(this.ctx.save(),this.drawRectPath({x:r,y:s,width:n,height:h,radius:l}),this.ctx.clip()),this.ctx.drawImage(a,...g[c]||[],this.xDpr(r)||0,this.xDpr(s)||0,this.xDpr(n||e.width),this.xDpr(h||e.height)),l&&this.ctx.restore(),t()},fail:()=>{i(u(106))}})},a.onerror=()=>{i(u(107))}})}drawText(t){return new Promise((e,i)=>{const o={x:0,y:0,color:"#000",fontSize:12,fontWeight:"",width:1/0,baseline:"top",align:"left",...t,text:String(t.text)||"",ellipsis:Math.max(+t.ellipsis,0),lineHeight:t.lineHeight||t.fontSize||12};let r=0,s=0,n=[];this.ctx.setTextAlign=o.align,this.ctx.textBaseline=o.baseline,this.ctx.fillStyle=o.color,this.ctx.font=`${o.fontWeight} ${this.xDpr(o.fontSize)}px ${this.fontFamily}`,o.text.split("").forEach((t,e)=>{const i=o.text.slice(r,e+1);this.ctx.measureText(i).width<this.xDpr(o.width)?n[s]=i:(r=e,s++)}),o.ellipsis&&n.length>o.ellipsis&&(n=n.slice(0,o.ellipsis),n[o.ellipsis-1]=n[o.ellipsis-1].slice(0,-1)+"..."),n.forEach((t,e)=>{const i=o.y+o.lineHeight*e+(o.lineHeight-o.fontSize)/2;this.ctx.fillText(t,this.xDpr(o.x),this.xDpr(i))}),e()})}drawLine(t){return new Promise((e,i)=>{const o={lineStyle:{cap:"butt",join:"bevel",offset:0,dash:[1,0],color:"#000",width:1,...t.lineStyle},line:t.line||[]};this.ctx.lineCap=o.lineStyle.cap,this.ctx.setLineDash(o.lineStyle.dash.map(t=>this.xDpr(t))),this.ctx.lineDashOffset=this.xDpr(o.lineStyle.offset),this.ctx.lineJoin=o.lineStyle.join,this.ctx.lineWidth=this.xDpr(o.lineStyle.width),this.ctx.strokeStyle=o.lineStyle.color,o.line.forEach((t,e)=>{e?(this.ctx.lineTo(...t.point.map(t=>this.xDpr(t))),this.ctx.stroke()):(this.ctx.beginPath(),this.ctx.moveTo(...t.point.map(t=>this.xDpr(t))))}),e()})}drawBlur(t){return new Promise((e,i)=>{const o={x:0,y:0,width:0,height:0,blur:0,...t},{x:r,y:s,width:n,height:c,blur:l}=o;try{h(this.canvas,this.xDpr(r),this.xDpr(s),this.xDpr(n),this.xDpr(c),l)}catch(t){i(t)}e()})}saveToAlbum(t){return new Promise((e,i)=>{const o={x:0,y:0,width:0,height:0,destWidth:0,destHeight:0,modalOption:{},...t};wx.canvasToTempFilePath({x:o.x,y:o.y,width:o.width,height:o.height,destWidth:this.xDpr(o.destWidth),destHeight:this.xDpr(o.destHeight),canvas:this.canvas,success:t=>{const r=t.tempFilePath;x("writePhotosAlbum").then(t=>{1===t.code?wx.showModal({title:o.modalOption.title||"获取权限",content:o.modalOption.content||"请前往开启相册权限",success:o.modalOption.success||(t=>{t.confirm?(wx.openSetting(),this.debugLogout(d[105]+" (105)","error"),i(u(105))):t.cancel&&(this.debugLogout(d[104]+" (104)","error"),i(u(104)))})}):[2,3].includes(t.code)&&g(r).then(t=>{this.debugLogout("保存图片到相册成功"),e()}).catch(()=>{this.debugLogout(d[102]+" (102)","error"),i(u(102))})}).catch(()=>{this.debugLogout(d[101]+" (101)","error"),i(u(101))})},fail:()=>{this.debugLogout(d[100]+" (100)","error"),i(u(100))}})})}debugLogout(...t){this.debugger&&p(...t)}}a.extendDrawMethods={},a.addSeries=function(t,e){a.extendDrawMethods[t]=e};const d={100:"生成图片失败",101:"获取设置信息失败",102:"保存图片到相册失败",103:"授权失败",104:"用户拒绝授权",105:"用户前往授权页",106:"获取图片信息失败",107:"加载图片失败"},u=function(t){return{code:t,msg:d[t]}},x=function(t){return new Promise((e,i)=>{wx.getSetting({success(i){const o=t=>({settings:i,code:t});void 0!==i.authSetting["scope."+t]&&!0!==i.authSetting["scope."+t]?e(o(1)):void 0===i.authSetting["scope."+t]?e(o(2)):e(o(3))},fail(t){i(t)}})})},g=function(t){return new Promise((e,i)=>{wx.saveImageToPhotosAlbum({filePath:t,success:t=>{e()},fail:t=>{i(t)}})})},p=function(t,e="info"){if(!t)return;const i=function(e,i){console.log("%cWxCanvas2d%c"+t,`\n            color: ${e.color};\n            background-color: ${e.bgColor};\n            padding: 1px 4px;\n            border-radius: 4px 0 0 4px;\n        `,`\n            color: ${i.color};\n            background-color: ${i.bgColor};\n            padding: 1px 4px;\n            border-radius: 0 4px 4px 0;\n        `)};"devtools"===l.brand?"info"===e?i({color:"#004B1C",bgColor:"#2BDC70"},{color:"#084BBC",bgColor:"#81A9F0"}):"error"===e?i({color:"#006727",bgColor:"#2BDC70"},{color:"#D82E2E",bgColor:"#FFB2B2"}):console.log("WxCanvas2d: "+t):console.debug("WxCanvas2d: "+t)};e.default=a}])}));